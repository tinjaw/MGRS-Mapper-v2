<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="icon" href="data:," />
    <!-- <link rel="stylesheet" type="text/css" href="//unpkg.com/dialog-polyfill@0.4.10/dialog-polyfill.css" />
    <script src="https://unpkg.com/dialog-polyfill@0.4.10/dialog-polyfill.js"></script>
    <script src="https://unpkg.com/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/modern-normalize/0.5.0/modern-normalize.min.css" />
    <title>Component Test</title>
    <style>
      body {
        background: antiquewhite;
      }
      h6 {
        font-size: 1.4rem;
        text-decoration: underline;
      }
      svg {
        overflow: visible;
        border: 1px red solid;
      }
      .parent {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(4, 1fr);
        grid-column-gap: 0px;
        grid-row-gap: 0px;
        background: cornsilk;
        width: 100%;
        height: 100%;
        padding: 20px;
        text-align: center;
      }
      .div1 {
        grid-area: 1 / 1 / 2 / 2;
      }
      .div2 {
        grid-area: 2 / 1 / 3 / 2;
      }
      .div3 {
        grid-area: 3 / 1 / 4 / 2;
      }
      .div4 {
        grid-area: 4 / 1 / 5 / 2;
      }
      .div5 {
        grid-area: 1 / 2 / 5 / 3;
      }
      .parent span {
        font-size: 1.4rem;
        letter-spacing: 0.021rem;
      }
      .container {
        background: cornsilk;
        width: 100%;
        height: 100%;
        padding: 20px;
        text-align: center;
      }
      .centerPointInfo circle {
        transition: all 0.12s ease-in-out;
        transform-box: fill-box;
        transform-origin: center center;
      }
      .centerPointInfo:hover circle {
        transform: scale(1.5);
      }
      .centerPointInfo text {
        display: none;
      }
      .centerPointInfo:hover text {
        display: block;
        font-size: 4.4rem;
        font-weight: bold;
      }
      .pre-container {
        width: 100%;
      }
      div#pre-myJSONString {
        word-break: break-all;
      }
      #pre-myJSONString,
      #pre-regexString {
        border: 2px dashed #666;
        margin: 20px;
        padding: 10px;
        font-family: Roboto;
        letter-spacing: 1.15px;
        font-size: larger;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>HTML Component Test</h1>
      <app-navbar></app-navbar>
    </div>
    <form>
      <div>
        <label for="cvc"
          >Enter your CVC
          <popup-info img="https://placeimg.com/64/64/animals" data-text="Your card validation code (CVC) is an extra security feature — it is the last 3 or 4 numbers on the back of your card."></popup-info>
        </label>
        <input type="text" id="cvc" />
      </div>
    </form>
    <br />

    <br />
    <div class="container milsymbolContainer">
      <svg class="draggable" data-symbol-info='{"Symbol":"Infantry","Affiliation":"Friendly","Echelon":"corps","Modifier 1":"Foraging","Modifier 2":"Amphibious","Unique Designation":"A/2-101","Higher Formation":"27/42ID","Reinforced or Reduced":"+","Type":"Land Unit"}' height="100" width="150" preserveAspectRatio="xMidYMid" viewBox="25 4 233.265625 150.5">
        <desc>
          Affiliation: Friendly Echelon: corps Symbol: Infantry Modifier 1: Foraging Modifier 2: Amphibious About: This symbol was created by CPT James Pistell for MGRS-Mapper.com
        </desc>
        <g class="outline">
          <path stroke="black" stroke-width="4" d="M25,50 l150,0 0,100 -150,0 z" fill="rgb(128,224,255)"></path>
        </g>
        <g class="decorator">
          <path d="M25,50 L175,150 M25,150 L175,50" fill="none" stroke="black" stroke-width="4"></path>
        </g>
        <g class="echelon">
          <path d="M52.5,40 l25,-25 m0,25 l-25,-25 M87.5,40 l25,-25 m0,25 l-25,-25 M122.5,40 l25,-25 m0,25 l-25,-25" fill="black" stroke="black" stroke-width="4"></path>
        </g>
        <g class="mod1">
          <path d="M 12.5,3.5 a 22.5,22.5 0 0,1 0,43 a 22.5,22.5 0 1,0 0,-43 z" fill="none" stroke="black" stroke-width="6" transform="translate(110,75) scale(-0.4,-0.4)"></path>
        </g>
        <g class="mod2">
          <path d="m 25,145 c 18.8,0 0,-20 18.8,-20 18.8,0 0,20 18.8,20 18.8,0 0,-20 18.8,-20 18.8,0 0,20 18.8,20 18.8,0 0,-20 18.8,-20 18.8,0 0,20 18.8,20 18.8,0 0,-20 18.8,-20 18.8,0 0,20 20,20" fill="none" stroke="black" stroke-width="4"></path>
        </g>
        <g class="uniqueUnitDesignation">
          <text x="180" y="107.493" fill="black" font-weight="bold" font-family="Arial" font-size="22" text-anchor="start">A/2-101</text>
        </g>
        <g class="higherUnitFormation">
          <text x="180" y="150" fill="black" font-weight="bold" font-family="Arial" font-size="22" text-anchor="start">27/42ID</text>
        </g>
        <g class="reinforcedReduced">
          <text x="195" y="40" text-anchor="start" font-size="40" font-family="Arial" font-weight="bold" stroke-width="4" fill="black">+</text>
        </g>
      </svg>
    </div>
    <br />

    <div class="parent">
      <div class="div1">
        <h6>Mouse Screen Coordinates of Scaled SVG:</h6>
        <strong>X</strong> = <span id="x"></span><br />
        <strong>Y</strong> = <span id="y"></span>
      </div>
      <div class="div2">
        <h6 style="color:red;">Center of Outline Group:</h6>
        <strong>CX</strong> = <span id="cx"></span><br />
        <strong>CY</strong> = <span id="cy"></span>
      </div>
      <div class="div3">
        <h6 style="color:green;">Center of Outline Group in Screen Coordinates:</h6>
        <strong>PTX</strong> = <span id="ptx"></span><br />
        <strong>PTY</strong> = <span id="pty"></span>
      </div>
      <div class="div4">
        <h6 style="color:orange;">Center of Entire SVG:</h6>
        <strong>SVG CX</strong> = <span id="svgcx"></span><br />
        <strong>SVG CY</strong> = <span id="svgcy"></span>
      </div>
      <div class="div5">
        <h6 style="color:blue;">SVG Object Data:</h6>
        <div class="pre-container">
          <pre id="pre-regexString"></pre>
        </div>
      </div>
    </div>

    <script defer>
      const svg = document.querySelector('.milsymbolContainer > svg');
      //https://stackoverflow.com/questions/22183727/how-do-you-convert-screen-coordinates-to-document-space-in-a-scaled-svg
      const getScreenCoordinatesOnScaledSVG = () => {
        const x = document.querySelector('#x');
        const y = document.querySelector('#y');

        svg.addEventListener('mousemove', event => {
          let pt = svg.createSVGPoint();
          pt.x = event.pageX;
          pt.y = event.pageY;
          pt = pt.matrixTransform(svg.getScreenCTM().inverse());

          x.innerHTML = pt.x.toFixed(4);
          y.innerHTML = pt.y.toFixed(4);
        });
      };

      //https://stackoverflow.com/questions/26867641/how-to-get-mid-point-of-g-tag-in-svg-using-javascript
      const getMidPointOfGTag = () => {
        const outline = document.querySelector('g.outline');
        const bbox = outline.getBBox();
        const ctm = outline.getCTM();

        // Calculate the center of the outline group
        let cx = bbox.x + bbox.width / 2;
        let cy = bbox.y + bbox.height / 2;

        document.querySelector('#cx').innerHTML = cx;
        document.querySelector('#cy').innerHTML = cy;
        svg.insertAdjacentHTML(
          'beforeend',
          `
          <g class="centerPointInfo">
            <text x=${cx} y=${cy - 50} fill="red" stroke="black" stroke-width="3" text-anchor="middle">Center of Outline Group</text>
            <circle cx=${cx} cy=${cy} r="6" stroke="black" stroke-width="2" fill="red"/>
          </g>
          `
        );

        // Calculate the center of entire SVG
        const svgbbox = svg.getBBox();
        let svgcx = svgbbox.x + svgbbox.width / 2;
        let svgcy = svgbbox.y + svgbbox.height / 2;

        document.querySelector('#svgcx').innerHTML = svgcx.toFixed(4);
        document.querySelector('#svgcy').innerHTML = svgcy.toFixed(4);
        svg.insertAdjacentHTML(
          'beforeend',
          `
          <g class="centerPointInfo">
            <text x=${svgcx} y=${svgcy - 50} fill="orange" stroke="black" stroke-width="3" text-anchor="middle">Center of Entire SVG</text>
            <circle cx=${svgcx} cy=${svgcy} r="6" stroke="black" stroke-width="2" fill="orange"/>
          </g>
          `
        );

        // Transform cx,cy by the outline group's transform
        let pt = svg.createSVGPoint();
        pt.x = cx;
        pt.y = cy;
        pt = pt.matrixTransform(ctm);

        document.querySelector('#ptx').innerHTML = pt.x.toFixed(4);
        document.querySelector('#pty').innerHTML = pt.y.toFixed(4);
        svg.insertAdjacentHTML(
          'beforeend',
          `
          <g class="centerPointInfo">
            <text x="0" y="15" fill="green" stroke="black" stroke-width="3" text-anchor="middle">Center of Outline Group in Screen Coordinates</text>
            <circle class="zoomIn" cx=${pt.x} cy=${pt.y} r="6" stroke="black" stroke-width="2" fill="green"/>
          </g>
          `
        );
      };

      function popupData(event) {
        'use strict';
        const elements = document.elementsFromPoint(event.clientX, event.clientY);
        const chosenTarget = elements.find(key => key.matches('.draggable'));
        const symbolData = {
          bbox: {
            x: chosenTarget.getBBox().x,
            y: chosenTarget.getBBox().y,
            width: chosenTarget.getBBox().width,
            height: chosenTarget.getBBox().height
          },
          boundingClientRect: chosenTarget.getBoundingClientRect(),
          data: JSON.parse(chosenTarget.dataset.symbolInfo)
        };
        console.group(symbolData);
        outputSymbolDatasetToPreTags(JSON.stringify(symbolData));
      }

      svg.addEventListener('click', popupData);

      // Output symbol info to pre tags
      const outputSymbolDatasetToPreTags = element => {
        let myJSON = {};
        myJSON = JSON.parse(element);

        const myJSONString = JSON.stringify(myJSON);
        let regexString = '';
        // for tracking matches, in particular the curly braces
        const brace = {
          brace: 0
        };

        regexString = myJSONString.replace(/({|}[,]*|[^{}:]+:[^{}:,]*[,{]*)/g, (m, p1) => {
          const returnFunction = () => `<div style="text-indent: ${brace.brace * 20}px;">${p1.split(':')[0]} : <b>${p1.split(':')[1]}</b></div>`;
          let returnString = 0;

          if (p1.lastIndexOf('{') === p1.length - 1) {
            returnString = returnFunction();
            brace.brace += 1;
          } else if (p1.indexOf('}') === 0) {
            brace.brace = 1;
            returnString = returnFunction();
          } else {
            returnString = returnFunction();
          }
          return returnString
            .replace(/}, : /g, '}')
            .replace(/} : /g, '}')
            .replace(/undefined/g, '');
        });

        document.querySelector('#pre-regexString').innerHTML = '';
        document.querySelector('#pre-regexString').innerHTML = regexString;
        // Remove the "undefined" text in the first and last brackets
        document.querySelector('#pre-regexString').firstChild.innerText = '{';
        document.querySelector('#pre-regexString').lastChild.innerText = '}';
      };

      // ******** //
      // OLD SHIT //
      // ******** //

      class SymbolInfo extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({
            mode: 'open'
          });
          this.shadowRoot.innerHTML = `<h2>I am symbol info</h2>`;
        }
      }

      // window.customElements.define('symbol-info', SymbolInfo);

      // const infantryContainer = document.querySelector('.milsymbolContainer');
      // infantryContainer.insertAdjacentHTML('beforeend', `<symbol-info></symbol-info>`);

      // * APP NAV BAR * //
      class AppNavbar extends HTMLElement {
        constructor() {
          super();
          this.attachShadow({
            mode: 'open'
          });
          this.shadowRoot.innerHTML = `<h2>Hello World</h2>`;
        }

        static get observedAttributes() {
          return ['disabled', 'open'];
        }

        get disabled() {
          return this.hasAttribute('disabled');
        }

        set disabled(val) {
          if (val) {
            this.setAttribute('disabled', '');
          } else {
            this.removeAttribute('disabled');
          }
        }
        // Only called for the disabled and open attributes due to observedAttributes
        attributeChangedCallback(name, oldValue, newValue) {
          console.table({ name, oldValue, newValue });
          // When the drawer is disabled, update keyboard/screen reader behavior.
          if (this.disabled) {
            this.setAttribute('tabindex', '-1');
            this.setAttribute('aria-disabled', 'true');
          } else {
            this.setAttribute('tabindex', '0');
            this.setAttribute('aria-disabled', 'false');
          }
          // TODO: also react to the open attribute changing.
        }
      }
      window.customElements.define('app-navbar', AppNavbar);

      // Create a class for the element
      class PopUpInfo extends HTMLElement {
        constructor() {
          // Always call super first in constructor
          super();

          // Create a shadow root
          const shadow = this.attachShadow({ mode: 'open' });

          // Create spans
          const wrapper = document.createElement('span');
          wrapper.setAttribute('class', 'wrapper');

          const icon = document.createElement('span');
          icon.setAttribute('class', 'icon');
          icon.setAttribute('tabindex', 0);

          const info = document.createElement('span');
          info.setAttribute('class', 'info');

          // Take attribute content and put it inside the info span
          const text = this.getAttribute('data-text');
          info.textContent = text;

          //Insert icon
          let imgUrl;
          if (this.hasAttribute('img')) {
            imgUrl = this.getAttribute('img');
          } else {
            imgUrl = 'https://placeimg.com/64/64/people';
          }

          const img = document.createElement('img');
          img.src = imgUrl;
          icon.appendChild(img);

          // Create some CSS to apply to the shadow dom
          const style = document.createElement('style');
          console.log('Is the style connected: ', style.isConnected);

          style.textContent = `
                  .wrapper {
                    position: relative;
                  }
                  .info {
                    font-size: 0.8rem;
                    width: 200px;
                    display: inline-block;
                    border: 1px solid black;
                    padding: 10px;
                    background: white;
                    border-radius: 10px;
                    opacity: 0;
                    transition: 0.6s all;
                    position: absolute;
                    bottom: 20px;
                    left: 10px;
                    z-index: 3;
                  }
                  img {
                    width: 1.2rem;
                  }
                  .icon:hover + .info, .icon:focus + .info {
                    opacity: 1;
                  }
                `;

          // Attach the created elements to the shadow dom
          shadow.appendChild(style);
          console.log('Is the style connected: ', style.isConnected);
          shadow.appendChild(wrapper);
          wrapper.appendChild(icon);
          wrapper.appendChild(info);
        }

        static get observedAttributes() {
          return ['disabled', 'open', 'clicked'];
        }

        connectedCallback() {
          console.log('Custom square element added to page.');
          //updateStyle(this);
        }

        disconnectedCallback() {
          console.log('Custom square element removed from page.');
        }

        adoptedCallback() {
          console.log('Custom square element moved to new page.');
        }
        attributeChangedCallback(name, oldValue, newValue) {
          console.table({ name, oldValue, newValue });
          //updateStyle(this);
        }
      }

      function updateStyle(elem) {
        const shadow = elem.shadowRoot;
        shadow.querySelector('style').textContent = `
          div {
            width: ${elem.getAttribute('l')}px;
            height: ${elem.getAttribute('l')}px;
            background-color: ${elem.getAttribute('c')};
          }
        `;
      }

      // const popupImg = document.querySelector('popup-info');
      // popupImg.addEventListener('click', event => {
      //   event.target.toggleAttribute('clicked');
      // });

      // const infantry = document.querySelector('svg');
      // infantry.insertAdjacentHTML('beforeend', `<popup-info img="https://placeimg.com/64/64/animals" data-text="Your card validation code (CVC) is an extra security feature — it is the last 3 or 4 numbers on the back of your card."></popup-info>`);

      // Define the new element
      //customElements.define('popup-info', PopUpInfo);
      document.addEventListener('DOMContentLoaded', event => {
        getScreenCoordinatesOnScaledSVG();
        getMidPointOfGTag();
        outputSymbolDatasetToPreTags(svg.dataset.symbolInfo);
      });
    </script>
  </body>
</html>
